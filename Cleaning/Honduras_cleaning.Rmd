# Honduras Data de la Encuesta de Hogares 2024


## 1. Cargar librerías
```{r}
library(readr)
library(dplyr)
library(janitor)
library(haven)
```

```{r}
zonas_hn <- tribble(
  ~depto, ~depto_name,          ~dept_geo_code, ~munic, ~munic_name,

  1,  "Atlántida",         "HNAT", 0, "Departamento completo",
  2,  "Colón",             "HNCL", 0, "Departamento completo",
  3,  "Comayagua",         "HNCM", 0, "Departamento completo",
  4,  "Copán",             "HNCP", 0, "Departamento completo",
  5,  "Cortés",            "HNCR", 0, "Departamento completo",
  6,  "Choluteca",         "HNCH", 0, "Departamento completo",
  7,  "El Paraíso",        "HNEP", 0, "Departamento completo",
  8,  "Francisco Morazán", "HNFM", 0, "Departamento completo",
  9,  "Gracias a Dios",    "HNGD", 0, "Departamento completo",
  10, "Intibucá",          "HNIN", 0, "Departamento completo",
  11, "Islas de la Bahía", "HNIB", 0, "Departamento completo",
  12, "La Paz",            "HNLP", 0, "Departamento completo",
  13, "Lempira",           "HNLE", 0, "Departamento completo",
  14, "Ocotepeque",        "HNOC", 0, "Departamento completo",
  15, "Olancho",           "HNOL", 0, "Departamento completo",
  16, "Santa Bárbara",     "HNSB", 0, "Departamento completo",
  17, "Valle",             "HNVA", 0, "Departamento completo",
  18, "Yoro",              "HNYO", 0, "Departamento completo"
)
```

## Importar base de datos
```{r}
encuesta_hogares <- read_sav("~/Desktop/UchicagoPolicyLab-Migration/Data/Honduras/Data de la Encuesta de Hogares 2024_PDVF/Data de la Encuesta de Hogares 2024_PDVF.sav")
encuesta_hogares
```

```{r}
dicc <- data.frame(
  variable = names(encuesta_hogares),
  label = sapply(encuesta_hogares, function(x) attr(x, "label"))
)

dicc
```
```{r}
# Crear base municipal con columnas dummy para municipio (
# La encuesta de hogares no tiene informacion por municipio - asignamos valor 0
base_muni <- encuesta_hogares %>%
  distinct(
    depto= DEPMUESTRA,
  ) %>%
  mutate(
    munic = 0,
  ) %>%
  arrange(depto, munic)

base_muni

```

# Varoables poblaciones

```{r}

# ---  Crear columnas binarias para sexo ---
encuesta_hogares <- encuesta_hogares %>%
  mutate(
    sexo_hombre = ifelse(SEXO == 1, FACTOR, 0),  # ponderado
    sexo_mujer  = ifelse(SEXO == 2, FACTOR, 0)   # ponderado
  )


# --- Calcular agregados con pesos ---
agg_poblacion <- encuesta_hogares %>%
  mutate(
    peso = FACTOR
  ) %>%
  group_by(depto = DEPMUESTRA, munic = 0) %>%
  summarise(
    poblacion_total   = sum(peso, na.rm = TRUE),          # con pesos
    poblacion_hombres = sum(sexo_hombre, na.rm = TRUE),   # con pesos
    poblacion_mujeres = sum(sexo_mujer, na.rm = TRUE),    # con pesos
    .groups = "drop"
  )


# ---  Unir al master municipal ---
base_muni <- base_muni %>%
  left_join(
    agg_poblacion,
    by = c("depto",  "munic")
  )

base_muni

```


```{r}
# -----------------------------------------
# Education indicators (Honduras, ponderado)
# -----------------------------------------

encuesta_hogares <- encuesta_hogares %>%
  mutate(
    edad = EDAD,

    # Matrícula anual (para Net Enrollment)
    enrolled = ifelse(ED02 == 1, FACTOR, 0),
    not_enrolled = ifelse(ED02 != 1, FACTOR, 0),


    # Alfabetismo (directo, ED01)
    # literate        = ifelse(ED01 == 1, FACTOR, 0),
    
    # --- Alfabetismo proxy (≥ 1 grado aprobado) ---
    literate = ifelse(ED08 >= 2, FACTOR, 0),

    # Grupos etarios
    primary_age            = ifelse(edad >= 7  & edad <= 12, FACTOR, 0),
    lower_secondary_age    = ifelse(edad >= 13 & edad <= 15, FACTOR, 0),
    adult_age              = ifelse(edad >= 15, FACTOR, 0),
    youth_age              = ifelse(edad >= 15 & edad <= 24, FACTOR, 0),

    # Completion según ED08 (grado aprobado)
    complete_primary          = ifelse(ED08 >= 6, FACTOR, 0),
    complete_lower_secondary  = ifelse(ED08 >= 9, FACTOR, 0)
  )


```
```{r}
encuesta_hogares %>%
  select(
    DEPMUESTRA,
    FACTOR,
    EDAD,
    ED02,
    ED03,
    ED08,

    # variables derivadas
    edad,
    enrolled,
    not_enrolled,
    literate,
    primary_age,
    lower_secondary_age,
    adult_age,
    youth_age,
    complete_primary,
    complete_lower_secondary
  ) %>%
  head(100)
```
```{r}
encuesta_hogares %>%
  filter(EDAD >= 13 & EDAD <= 15) %>%
  select(
    EDAD,
    FACTOR,
    ED02,
    enrolled,
    not_enrolled
  ) %>%
  head(20)
```

```{r}
agg_education <- encuesta_hogares%>%
  group_by(depto = DEPMUESTRA, munic = 0) %>%
  summarise(

    # Out of School (13–15)
    adolescents_out_of_school_count  = sum(not_enrolled * (edad >= 13 & edad <= 15) , na.rm = TRUE),
    adolescents_population_13_15     = sum((edad >= 13 & edad <= 15)*FACTOR, na.rm = TRUE),
    adolescents_out_of_school_rate   = 100 * adolescents_out_of_school_count / adolescents_population_13_15,
    
    
    # Adult Literacy (15+)
    adult_literate_count       = sum(literate * (edad >= 15), na.rm = TRUE),
    adult_population_15_plus   = sum((edad >= 15) * FACTOR, na.rm = TRUE),
    adult_literacy_rate        = 100 * adult_literate_count / adult_population_15_plus,

    # Youth Literacy (15–24)
    youth_literate_count       = sum(literate * (edad >= 15 & edad <= 24), na.rm = TRUE),
    youth_population_15_24     = sum((edad >= 15 & edad <= 24) * FACTOR, na.rm = TRUE),
    youth_literacy_rate        = 100 * youth_literate_count / youth_population_15_24,

    # Primary Completion
    primary_completion_count     = sum(complete_primary * (edad >= 7 & edad <= 12), na.rm = TRUE),
    primary_age_population       = sum((edad >= 7 & edad <= 12) * FACTOR, na.rm = TRUE),
    primary_school_age_population = sum((edad >= 7 & edad <= 12) * FACTOR, na.rm = TRUE),
    primary_completion_rate      = 100 * primary_completion_count / primary_age_population,

    # Lower Secondary Completion
    lower_secondary_completion_count = sum(complete_lower_secondary * (edad >= 13 & edad <= 15), na.rm = TRUE),
    lower_secondary_age_population   = sum((edad >= 13 & edad <= 15) * FACTOR, na.rm = TRUE),
    lower_secondary_completion_rate  = 100 * lower_secondary_completion_count / lower_secondary_age_population,

    # Net Primary Enrollment (ED02)
    primary_enrolled_count   = sum(enrolled * (edad >= 7 & edad <= 12), na.rm = TRUE),
    primary_age_population   = sum((edad >= 7 & edad <= 12) * FACTOR, na.rm = TRUE),
    net_primary_enrollment_rate = 100 * primary_enrolled_count / primary_age_population,

    # Net Secondary Enrollment (ED02)
    secondary_enrolled_count = sum(enrolled * (edad >= 13 & edad <= 15), na.rm = TRUE),
    secondary_age_population = sum((edad >= 13 & edad <= 15) * FACTOR, na.rm = TRUE),
    net_secondary_enrollment_rate = 100 * secondary_enrolled_count / secondary_age_population

  )

```

```{r}
base_muni <- base_muni %>%
  left_join(agg_education, by = c("depto", "munic"))

base_muni
```


# Employment variables 
```{r}
# ======================================================
#   EMPLOYMENT INDICATORS — HONDURAS (EPHPM 2024)
# ======================================================

# AGE GROUP FLAGS (0/1 indicators)
encuesta_hogares <- encuesta_hogares %>%
  mutate(
    edad = EDAD,
    child_labor_age  = ifelse(edad >= 7  & edad <= 14, 1, 0),
    youth_age_lfpr   = ifelse(edad >= 15 & edad <= 24, 1, 0),
    adult_age_lfpr   = ifelse(edad >= 15, 1, 0)
  )

# EMPLOYMENT STATUS (weighted using FACTOR)
encuesta_hogares <- encuesta_hogares %>%
  mutate(
    employed    = ifelse(CONDACT == 1, FACTOR, 0),
    unemployed  = ifelse(CONDACT == 2, FACTOR, 0),
    labor_force = ifelse(CONDACT %in% c(1,2), FACTOR, 0)
  )

#  NEET (15–24) — Not studying, not employed, not unemployed
encuesta_hogares <- encuesta_hogares %>%
  mutate(
    neet = ifelse(
      youth_age_lfpr == 1 &
      ED02 != 1 & ED03 != 1 &       # not in school
      !(CONDACT %in% c(1,2)),       # not employed or unemployed
      FACTOR, 0
    )
  )

#  VULNERABLE EMPLOYMENT
#    ILO: own-account + unpaid family workers
encuesta_hogares <- encuesta_hogares %>%
  mutate(
    vulnerable_emp = ifelse(CATEGOP %in% c(4,6), FACTOR, 0)  # cuenta propia + trabajador familiar
  )

# ======================================================
#   AGGREGATION (Weighted)
# ======================================================

agg_employment <- encuesta_hogares %>%
  group_by(depto = DEPMUESTRA, munic = 0) %>%
  summarise(
    
    # -------------------------------
    # CHILD LABOR (7–14)
    # -------------------------------
    child_employment_count = sum(employed * child_labor_age, na.rm = TRUE),
    child_population_7_14  = sum(child_labor_age * FACTOR, na.rm = TRUE),
    child_employment_rate  = 100 * child_employment_count / child_population_7_14,

    # -------------------------------
    # YOUTH LFPR (15–24)
    # -------------------------------
    youth_labor_force_count = sum(labor_force * youth_age_lfpr, na.rm = TRUE),
    youth_population_15_24  = sum(youth_age_lfpr * FACTOR, na.rm = TRUE),
    youth_lfpr_rate         = 100 * youth_labor_force_count / youth_population_15_24,

    # -------------------------------
    # ADULT LFPR (15+)
    # -------------------------------
    labor_force_count  = sum(labor_force * adult_age_lfpr, na.rm = TRUE),
    population_15_plus = sum(adult_age_lfpr * FACTOR, na.rm = TRUE),
    lfpr_rate          = 100 * labor_force_count / population_15_plus,

    # -------------------------------
    # NEET (15–24)
    # -------------------------------
    neet_count            = sum(neet * youth_age_lfpr, na.rm = TRUE),
    neet_population_15_24 = sum(youth_age_lfpr * FACTOR, na.rm = TRUE),
    neet_rate             = 100 * neet_count / neet_population_15_24,

    # -------------------------------
    # TOTAL UNEMPLOYMENT (15+)
    # -------------------------------
    unemployment_count             = sum(unemployed * adult_age_lfpr, na.rm = TRUE),
    labor_force_population_15_plus = sum(labor_force * adult_age_lfpr, na.rm = TRUE),
    unemployment_rate              = 100 * unemployment_count / labor_force_population_15_plus,

    # -------------------------------
    # YOUTH UNEMPLOYMENT (15–24)
    # -------------------------------
    youth_unemployment_count      = sum(unemployed * youth_age_lfpr, na.rm = TRUE),
    youth_labor_force_population  = sum(labor_force * youth_age_lfpr, na.rm = TRUE),
    youth_unemployment_rate       = 100 * youth_unemployment_count / youth_labor_force_population,

    # -------------------------------
    # VULNERABLE EMPLOYMENT
    # -------------------------------
    vulnerable_employment_count = sum(vulnerable_emp * adult_age_lfpr, na.rm = TRUE),
    employed_population         = sum(employed, na.rm = TRUE),
    vulnerable_employment_rate  = 100 * vulnerable_employment_count / employed_population
  )

# ======================================================
#   MERGE INTO MUNICIPAL (dummy muni = 0)
# ======================================================

base_muni <- base_muni %>%
  left_join(agg_employment, by = c("depto", "munic"))

base_muni


```
```{r}
encuesta_hogares
```




```{r}
# ======================================================
# HOGARES SUMMARY – HONDURAS (EPHPM 2024)
# ======================================================
hogares_summary <- encuesta_hogares %>%
  clean_names() %>%
  
  # -----------------------
  # Identificador único por hogar
  # -----------------------
  mutate(
    hogar_id = paste0(hogar, "_", num_hog),

    # Honduras NO tiene municipios → ponemos 0
    munic = 0,

    # Departamento correcto
    depto = depmuestra,

    # Recibe remesas si cualquier campo > 0
    receives_remittances = ifelse(
      oih12_lps > 0 | 
      oih12_us > 0 |
      oih12_lps_esp > 0 | 
      oih12_us_esp > 0 | 
      yhrem > 0,
      1, 0
    ),

    # Área urbana / rural
    urban_rural = case_when(
      ur == 1 ~ "urban",
      ur == 2 ~ "rural",
      TRUE ~ NA_character_
    )
  ) %>%

  # -----------------------------------------------
  # PRIMER PASO: un solo peso por hogar
  # -----------------------------------------------
  group_by(hogar_id, depto, munic) %>%
  summarise(
    peso_hogar = first(factor),              # peso único para el hogar
    receives_remittances = first(receives_remittances),
    oih12_lps = sum(oih12_lps, na.rm = TRUE),    # sumado a nivel hogar
    oih12_us  = sum(oih12_us,  na.rm = TRUE),
    .groups = "drop"
  ) %>%

  # -----------------------------------------------
  # SEGUNDO PASO: agregación por departamento
  # -----------------------------------------------
  group_by(depto, munic) %>%
  summarise(
    # Hogares expandidos
    total_households = sum(peso_hogar, na.rm = TRUE),

    # Hogares que reciben remesas (expandidos)
    households_receiving_remittances =
      sum(receives_remittances * peso_hogar, na.rm = TRUE),

    # Monto total de remesas, expandido
    total_remittances_lps =
      sum(oih12_lps * peso_hogar, na.rm = TRUE),

    total_remittances_usd =
      sum(oih12_us * peso_hogar, na.rm = TRUE),

    # Porcentaje
    pct_households_receiving_remittances =
      100 * households_receiving_remittances / total_households,

    .groups = "drop"
  )

hogares_summary

```

```{r}
base_muni <- base_muni %>%
  left_join(hogares_summary, by = c("depto", "munic"))

base_muni
```

# We need to call the Encuesta de MIgracion y remesas para completar nuestras columnas

```{r}
encuesta_migracion <- read_sav("~/Desktop/UchicagoPolicyLab-Migration/Data/Honduras/Encuesta de Migraci¢n y Remesas_2023/Data de Emigrantes.sav")%>%
  clean_names()
  
encuesta_migracion
```

```{r}

# ============================================================
# HONDURAS — HOGARES_SUMMARY (Migración y Remesas)
# ============================================================

hogares_summary <- encuesta_migracion %>%
  clean_names() %>%

  # Peso expansion
  mutate(peso = factor_exp_e) %>%

  # Filtrar emigrantes últimos 10 años
  mutate(year_left = as.numeric(emi006)) %>%
  filter(!is.na(year_left), year_left >= (2024 - 500)) %>%

  #  Emigrante flag (1 fila = 1 emigrante)
  mutate(
    emigrant = ifelse(mi001 == 1, 1, 0),
    emigrant_weighted = emigrant * peso,
  ) %>%

  # Agrupar por hogar para contar emigrantes por hogar
  group_by(
    depto = emi001_depto,
    munic = 0,
    id,
    num_hog
  ) %>%
  summarise(
    num_emigrants = sum(emigrant_weighted, na.rm = TRUE),
    .groups = "drop"
  ) %>%

  # Clasificaciones por hogar
  mutate(
    emigrant_household = ifelse(num_emigrants > 0, 1, 0),
    one_emigrant       = ifelse(num_emigrants >= 1, 1, 0),
    multiple_emigrants = ifelse(num_emigrants >= 2, 1, 0)
  ) %>%

  # 6. Resumen a nivel departamental
  group_by(depto, munic) %>%
  summarise(
    
    households_with_emigrants = sum(emigrant_household, na.rm = TRUE),
    households_with_1_emigrant = sum(one_emigrant, na.rm = TRUE),
    households_with_2plus_emigrants = sum(multiple_emigrants, na.rm = TRUE),

    total_emigrants_household = sum(num_emigrants, na.rm = TRUE),
    
  
    .groups = "drop"
  )

hogares_summary



```
```{r}
base_muni <- base_muni %>%
  left_join(hogares_summary, by = c("depto", "munic")) %>%
  mutate(
    pct_households_with_emigrants =
      100 * households_with_emigrants / total_households
  )

base_muni <- base_muni %>% 
  select(-ends_with(".y"))



base_muni
```
```{r}
base_muni <- base_muni %>%
  mutate(
    depto = sprintf("%02d", as.numeric(depto)),
    munic = sprintf("%02d", as.numeric(munic))
  ) %>%
  left_join(
    zonas_hn %>%
      mutate(
        depto = sprintf("%02d", as.numeric(depto)),
        munic = sprintf("%02d", as.numeric(munic))
      ),
    by = c("depto", "munic")
  )


base_muni <- base_muni %>% 
  select(-ends_with(".y"))
base_muni
```

```{r}

write_csv(base_muni,
          "../Data/Honduras/Processed/municipality_summary.csv")

```

## Now lets create the data base for emigrants

```{r}
library(dplyr)
library(janitor)

emigration_clean <- encuesta_migracion %>%
  clean_names() %>%

  # -------------------------
  # SELECT equivalent variables
  # -------------------------
  select(
    depto  = emi001_depto,
    munic  = emi001_muni,

    cod_viv = id,
    cod_hog = num_hog,
    cod_emig = orden,

    sex  = mi005,               # sexo
    age_at_emigration = mi006,  # edad al irse
    year_departure = emi006,    # año en que se fue
    destination_country = emi007,

    cause_emigration = emi009,  # causa A, B, C...

    urban_rural = ur,           # 1 urbano, 2 rural

    factor_exp_e               # peso expansion
  ) %>%

  # ---------------------------------------------------------
  #  AGE GROUPS
  # ---------------------------------------------------------
  mutate(
    age_group_emigration = case_when(
      age_at_emigration >= 0   & age_at_emigration <= 4   ~ "0-4",
      age_at_emigration >= 5   & age_at_emigration <= 9   ~ "5-9",
      age_at_emigration >= 10  & age_at_emigration <= 14  ~ "10-14",
      age_at_emigration >= 15  & age_at_emigration <= 19  ~ "15-19",
      age_at_emigration >= 20  & age_at_emigration <= 24  ~ "20-24",
      age_at_emigration >= 25  & age_at_emigration <= 29  ~ "25-29",
      age_at_emigration >= 30  & age_at_emigration <= 34  ~ "30-34",
      age_at_emigration >= 35  & age_at_emigration <= 39  ~ "35-39",
      age_at_emigration >= 40  & age_at_emigration <= 44  ~ "40-44",
      age_at_emigration >= 45  & age_at_emigration <= 49  ~ "45-49",
      age_at_emigration >= 50  & age_at_emigration <= 54  ~ "50-54",
      age_at_emigration >= 55  & age_at_emigration <= 59  ~ "55-59",
      age_at_emigration >= 60  & age_at_emigration <= 64  ~ "60-64",
      age_at_emigration >= 65  & age_at_emigration <= 69  ~ "65-69",
      age_at_emigration >= 70  & age_at_emigration <= 74  ~ "70-74",
      age_at_emigration >= 75  & age_at_emigration <= 79  ~ "75-79",
      age_at_emigration >= 80  & age_at_emigration <= 84  ~ "80-84",
      age_at_emigration >= 85  & age_at_emigration <= 89  ~ "85-89",
      age_at_emigration >= 90  & age_at_emigration <= 94  ~ "90-94",
      age_at_emigration >= 95                           ~ "95+",
      TRUE ~ NA_character_
    )
  ) %>%

  # ---------------------------------------------------------
  #  BINARY VARIABLES
  # ---------------------------------------------------------
  mutate(
    male   = ifelse(sex == 1, 1, 0),
    female = ifelse(sex == 2, 1, 0),

    urban  = ifelse(urban_rural == 1, 1, 0),
    rural  = ifelse(urban_rural == 2, 1, 0)
  )

emigration_clean

```
```{r}
library(stringr)
library(dplyr)
library(tidyr)

emigration_summary <- emigration_clean %>%
  # Renombramos para evitar el conflicto
  rename(cause_codes = cause_emigration) %>%
  
  mutate(
    sex = case_when(
      sex == 1 ~ "male",
      sex == 2 ~ "female",
      TRUE ~ NA_character_
    ),
    urban_rural = case_when(
      urban_rural == 1 ~ "urban",
      urban_rural == 2 ~ "rural",
      TRUE ~ NA_character_
    ),

    # ------------------------------------------------------------
    # DETECT MULTIPLE LETTER CAUSES (A, B, C, ... P)
    # ------------------------------------------------------------
    cause_family_reunification     = ifelse(str_detect(cause_codes, "A"), 1, 0),
    cause_low_income               = ifelse(str_detect(cause_codes, "B"), 1, 0),
    cause_unemployment             = ifelse(str_detect(cause_codes, "C"), 1, 0),
    cause_job_search               = ifelse(str_detect(cause_codes, "D"), 1, 0),
    cause_lack_education_access    = ifelse(str_detect(cause_codes, "E"), 1, 0),
    cause_lack_health_access       = ifelse(str_detect(cause_codes, "F"), 1, 0),
    cause_lack_basic_services      = ifelse(str_detect(cause_codes, "G"), 1, 0),
    cause_domestic_violence        = ifelse(str_detect(cause_codes, "H"), 1, 0),
    cause_food_insecurity          = ifelse(str_detect(cause_codes, "I"), 1, 0),
    cause_crop_loss                = ifelse(str_detect(cause_codes, "J"), 1, 0),
    cause_marriage_union           = ifelse(str_detect(cause_codes, "K"), 1, 0),
    cause_community_insecurity     = ifelse(str_detect(cause_codes, "L"), 1, 0),
    cause_victim_of_violence       = ifelse(str_detect(cause_codes, "M"), 1, 0),
    cause_threats_extortion        = ifelse(str_detect(cause_codes, "N"), 1, 0),
    cause_natural_disaster         = ifelse(str_detect(cause_codes, "O"), 1, 0),
    cause_other                    = ifelse(str_detect(cause_codes, "P"), 1, 0)
  ) %>%

  # ------------------------------------------------------------
  #  PIVOT LONG (solo las binarias)
  # ------------------------------------------------------------
  pivot_longer(
    cols = starts_with("cause_") & !contains("cause_codes"),
    names_to = "cause",
    values_to = "flag"
  ) %>%
  filter(flag == 1) %>%  # solo causas marcadas
  select(-flag) %>%

  # ------------------------------------------------------------
  #  SUMARIA PONDERADA
  # ------------------------------------------------------------
  group_by(
    depto, munic,
    sex,
    urban_rural,
    cause,
    year_departure,
    age_group_emigration
  ) %>%
  summarise(
    emigrants = sum(factor_exp_e, na.rm = TRUE),
    .groups = "drop"
  )

emigration_summary


```

```{r}
emigration_summary <- emigration_summary %>%
  mutate(
    depto = as.numeric(depto)
  ) %>%
  left_join(
    zonas_hn %>%
      distinct(depto, depto_name, dept_geo_code) %>%   # ONLY dept-level info
      mutate(depto = as.numeric(depto)),
    by = "depto"
  )

emigration_summary

```
```{r}
write_csv(emigration_summary,
          "../Data/Honduras/Processed/emigration_summary.csv")
```

