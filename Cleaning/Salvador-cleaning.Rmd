# Censo El Salvador 2024 — Script de Limpieza (Formato RMarkdown)

## 1. Cargar librerías
```{r}
library(readr)
library(dplyr)
library(janitor)
```
## I am going to include the names of departmenys and municipalities 
```{r}
zonas_sv <- tribble(
  ~depto, ~depto_name,   ~dept_geo_code, ~munic, ~munic_name,

  # --- Ahuachapán (01) ---
  1, "Ahuachapán", "SVAH", 1, "Ahuachapán Centro",
  1, "Ahuachapán", "SVAH", 2, "Ahuachapán Norte",
  1, "Ahuachapán", "SVAH", 3, "Ahuachapán Sur",

  # --- Santa Ana (02) ---
  2, "Santa Ana", "SVSA", 1, "Santa Ana Centro",
  2, "Santa Ana", "SVSA", 2, "Santa Ana Este",
  2, "Santa Ana", "SVSA", 3, "Santa Ana Norte",
  2, "Santa Ana", "SVSA", 4, "Santa Ana Oeste",

  # --- Sonsonate (03) ---
  3, "Sonsonate", "SVSO", 1, "Sonsonate Centro",
  3, "Sonsonate", "SVSO", 2, "Sonsonate Este",
  3, "Sonsonate", "SVSO", 3, "Sonsonate Norte",
  3, "Sonsonate", "SVSO", 4, "Sonsonate Oeste",

  # --- Chalatenango (04) ---
  4, "Chalatenango", "SVCH", 1, "Chalatenango Centro",
  4, "Chalatenango", "SVCH", 2, "Chalatenango Norte",
  4, "Chalatenango", "SVCH", 3, "Chalatenango Sur",

  # --- La Libertad (05) ---
  5, "La Libertad", "SVLI", 1, "La Libertad Centro",
  5, "La Libertad", "SVLI", 2, "La Libertad Costa",
  5, "La Libertad", "SVLI", 3, "La Libertad Este",
  5, "La Libertad", "SVLI", 4, "La Libertad Norte",
  5, "La Libertad", "SVLI", 5, "La Libertad Oeste",
  5, "La Libertad", "SVLI", 6, "La Libertad Sur",

  # --- San Salvador (14) ---
  14, "San Salvador", "SVSS", 1, "San Salvador Centro",
  14, "San Salvador", "SVSS", 2, "San Salvador Este",
  14, "San Salvador", "SVSS", 3, "San Salvador Norte",
  14, "San Salvador", "SVSS", 4, "San Salvador Oeste",
  14, "San Salvador", "SVSS", 5, "San Salvador Sur",

  # --- Cuscatlán (06) ---
  6, "Cuscatlán", "SVCU", 1, "Cuscatlán Norte",
  6, "Cuscatlán", "SVCU", 2, "Cuscatlán Sur",

  # --- La Paz (07) ---
  7, "La Paz", "HNLP", 1, "La Paz Centro",
  7, "La Paz", "HNLP", 2, "La Paz Este",
  7, "La Paz", "HNLP", 3, "La Paz Oeste",

  # --- Cabañas (09) ---
  9, "Cabañas", "SVCA", 1, "Cabañas Este",
  9, "Cabañas", "SVCA", 2, "Cabañas Oeste",

  # --- San Vicente (08) ---
  8, "San Vicente", "SVSV", 1, "San Vicente Norte",
  8, "San Vicente", "SVSV", 2, "San Vicente Sur",

  # --- Usulután (10) ---
  10, "Usulután", "SVUS", 1, "Usulután Este",
  10, "Usulután", "SVUS", 2, "Usulután Norte",
  10, "Usulután", "SVUS", 3, "Usulután Oeste",

  # --- San Miguel (11) ---
  11, "San Miguel", "SVSM", 1, "San Miguel Centro",
  11, "San Miguel", "SVSM", 2, "San Miguel Norte",
  11, "San Miguel", "SVSM", 3, "San Miguel Oeste",

  # --- Morazán (12) ---
  12, "Morazán", "SVMO", 1, "Morazán Norte",
  12, "Morazán", "SVMO", 2, "Morazán Sur",

  # --- La Unión (13) ---
  13, "La Unión", "SVUN", 1, "La Unión Norte",
  13, "La Unión", "SVUN", 2, "La Unión Sur"
)

```

## 2. Importar base de POBLACIÓN
```{r}
poblacion <- read_csv(
  "~/Desktop/UchicagoPolicyLab-Migration/Data/El Salvador- Censo 2024/Raw Data /Base de Datos de Población - CPV 2024 SV.csv",
  locale = locale(encoding = "UTF-8"),
) %>% clean_names()
```

## 3. Revisar primeras filas
```{r}
head(poblacion, 20)
```

## 4. Crear base municipal consolidada
```{r}
base_muni <- poblacion %>%
distinct(
dep_codigo = depto,
dep_nombre = deptodesc,
mun_codigo = munic,
mun_nombre = municdesc
) %>%
arrange(dep_codigo, mun_codigo)

base_muni
```

# Varoables poblaciones

```{r}

#    Esto garantiza un solo registro por municipio
base_muni <- poblacion %>% 
  distinct(
    depto,
    deptodesc,
    munic,
    municdesc
  ) %>% 
  arrange(depto, munic)

#Crear columnas binarias para sexo
poblacion <- poblacion %>%
  mutate(
    sexo_hombre = ifelse(p02_2_sexo == 1, 1, 0),
    sexo_mujer  = ifelse(p02_2_sexo == 2, 1, 0)
  )

# Calcular agregados de población por municipio
agg_poblacion <- poblacion %>%
  group_by(depto, deptodesc, munic, municdesc) %>%
  summarise(
    poblacion_total   = n(),
    poblacion_hombres = sum(sexo_hombre, na.rm = TRUE),
    poblacion_mujeres = sum(sexo_mujer, na.rm = TRUE),
    .groups = "drop"
  )

# Unir al master municipal
base_muni <- base_muni %>%
  left_join(agg_poblacion,
            by = c("depto", "deptodesc", "munic", "municdesc"))

base_muni
```

```{r}
# Education indicators:

# Basic flags
poblacion <- poblacion %>%
  mutate(
    attends_school  = ifelse(p09_educacion_formal == 1, 1, 0),
    not_attending   = ifelse(p09_educacion_formal != 1, 1, 0),
    literate        = ifelse(p12_analfabetismo == 1, 1, 0),

    primary_age            = ifelse(p02_3_edad >= 7  & p02_3_edad <= 12, 1, 0),
    lower_secondary_age    = ifelse(p02_3_edad >= 13 & p02_3_edad <= 15, 1, 0),
    adult_age              = ifelse(p02_3_edad >= 15, 1, 0),
    youth_age              = ifelse(p02_3_edad >= 15 & p02_3_edad <= 24, 1, 0)
  )

# Completion indicators
poblacion <- poblacion %>%
  mutate(
    complete_primary = ifelse(
      p10_grado_aprobado %in% c(5,6,7,8,9,10,11,12), 1, 0),

    complete_lower_secondary = ifelse(
      p10_grado_aprobado %in% c(6,7,8,9,10,11,12), 1, 0)
  )

# Aggregate counts + percentages
agg_education <- poblacion %>%
  group_by(depto, deptodesc, munic, municdesc) %>%
  summarise(
          # Adolescents Out of School (ages 13–15)
          # -------------------------
          adolescents_out_of_school_count      = sum(not_attending * lower_secondary_age, na.rm = TRUE),
          adolescents_population_13_15         = sum(lower_secondary_age, na.rm = TRUE),
          adolescents_out_of_school_rate       = 100 * adolescents_out_of_school_count / adolescents_population_13_15,
          
          # -------------------------
          # Adult Literacy (15+)
          # -------------------------
          adult_literate_count                 = sum(literate * adult_age, na.rm = TRUE),
          adult_population_15_plus             = sum(adult_age, na.rm = TRUE),
          adult_literacy_rate                  = 100 * adult_literate_count / adult_population_15_plus,
          
          # -------------------------
          # Youth Literacy (15–24)
          # -------------------------
          youth_literate_count                 = sum(literate * youth_age, na.rm = TRUE),
          youth_population_15_24               = sum(youth_age, na.rm = TRUE),
          youth_literacy_rate                  = 100 * youth_literate_count / youth_population_15_24,
          
          # -------------------------
          # Primary Completion
          # -------------------------
          primary_completion_count             = sum(complete_primary * primary_age, na.rm = TRUE),
          primary_school_age_population        = sum(primary_age, na.rm = TRUE),
          primary_completion_rate              = 100 * primary_completion_count / primary_school_age_population,
          
          # -------------------------
          # Lower Secondary Completion
          # -------------------------
          lower_secondary_completion_count     = sum(complete_lower_secondary * lower_secondary_age, na.rm = TRUE),
          lower_secondary_age_population       = sum(lower_secondary_age, na.rm = TRUE),
          lower_secondary_completion_rate      = 100 * lower_secondary_completion_count /lower_secondary_age_population,
          
          # -------------------------
          # Net Primary Enrollment
          # -------------------------
          primary_enrolled_count               = sum(attends_school * primary_age, na.rm = TRUE),
          primary_age_population               = sum(primary_age, na.rm = TRUE),
          net_primary_enrollment_rate          = 100 * primary_enrolled_count / primary_age_population,
          
          # -------------------------
          # Net Secondary Enrollment
          # -------------------------
          secondary_enrolled_count             = sum(attends_school * lower_secondary_age, na.rm = TRUE),
          secondary_age_population             = sum(lower_secondary_age, na.rm = TRUE),
          net_secondary_enrollment_rate        = 100 * secondary_enrolled_count / secondary_age_population
          )

# municipal dataset
base_muni <- base_muni %>%
  left_join(agg_education,
            by = c("depto", "deptodesc", "munic", "municdesc"))

head(base_muni, 20)
```


# Employment variables 
```{r}
# Define employment-related age groups
poblacion <- poblacion %>%
  mutate(
    child_labor_age      = ifelse(p02_3_edad >= 7  & p02_3_edad <= 14, 1, 0),
    youth_age_lfpr       = ifelse(p02_3_edad >= 15 & p02_3_edad <= 24, 1, 0),
    adult_age_lfpr       = ifelse(p02_3_edad >= 15, 1, 0)
  )

# Employment status
poblacion <- poblacion %>%
  mutate(
    employed    = ifelse(p15_1_activ_empleo %in% c(1,2,3), 1, 0),
    unemployed  = ifelse(p16_1_cond_activ %in% c(1,2), 1, 0),
    labor_force = ifelse(employed == 1 | unemployed == 1, 1, 0)
  )

# NEET (Not in Education, Employment or Training)
poblacion <- poblacion %>%
  mutate(
    neet = ifelse(
      youth_age_lfpr == 1 &
      p09_educacion_formal != 1 &   # not studying
      employed == 0 &
      unemployed == 0,
      1, 0)
  )

# Vulnerable employment
# Based on ILO standard: own-account + unpaid family workers
poblacion <- poblacion %>%
  mutate(
    vulnerable_emp = ifelse(p19_activ_cat_ocup %in% c(4,8,9), 1, 0)
  )
    agg_employment <- poblacion %>%
      group_by(depto, deptodesc, munic, municdesc) %>%
      summarise(
          
          # -------------------------------
          # Children in employment (ages 7–14)
          # -------------------------------
          child_employment_count          = sum(employed * child_labor_age, na.rm = TRUE),
          child_population_7_14           = sum(child_labor_age, na.rm = TRUE),
          child_employment_rate           = 100 * child_employment_count / child_population_7_14,
          
          # -------------------------------
          # Youth LFPR (ages 15–24)
          # -------------------------------
          youth_labor_force_count         = sum(labor_force * youth_age_lfpr, na.rm = TRUE),
          youth_population_15_24          = sum(youth_age_lfpr, na.rm = TRUE),
          youth_lfpr_rate                 = 100 * youth_labor_force_count / youth_population_15_24,
          
          # -------------------------------
          # Adult LFPR (ages 15+)
          # -------------------------------
          labor_force_count               = sum(labor_force * adult_age_lfpr, na.rm = TRUE),
          population_15_plus              = sum(adult_age_lfpr, na.rm = TRUE),
          lfpr_rate                       = 100 * labor_force_count / population_15_plus,
          
          # -------------------------------
          # Youth NEET (ages 15–24)
          # -------------------------------
          neet_count                      = sum(neet * youth_age_lfpr, na.rm = TRUE),
          neet_population_15_24           = sum(youth_age_lfpr, na.rm = TRUE),
          neet_rate                       = 100 * neet_count / neet_population_15_24,
          
          # -------------------------------
          # Total unemployment (15+)
          # -------------------------------
          unemployment_count              = sum(unemployed * adult_age_lfpr, na.rm = TRUE),
          labor_force_population_15_plus  = sum(labor_force * adult_age_lfpr, na.rm = TRUE),
          unemployment_rate               = 100 * unemployment_count / labor_force_population_15_plus,
          
          # -------------------------------
          # Youth unemployment (15–24)
          # -------------------------------
          youth_unemployment_count        = sum(unemployed * youth_age_lfpr, na.rm = TRUE),
          youth_labor_force_population    = sum(labor_force * youth_age_lfpr, na.rm = TRUE),
          youth_unemployment_rate         = 100 * youth_unemployment_count / youth_labor_force_population,
          
          # -------------------------------
          # Vulnerable employment
          # -------------------------------
          vulnerable_employment_count     = sum(vulnerable_emp * employed, na.rm = TRUE),
          employed_population             = sum(employed, na.rm = TRUE),
          vulnerable_employment_rate      = 100 * vulnerable_employment_count / employed_population

  )

# 6. Merge into municipal dataset
base_muni <- base_muni %>%
  left_join(agg_employment,
            by = c("depto", "deptodesc", "munic", "municdesc"))

base_muni
```

# Lets get remittances and the places with more emigrants as percentages
```{r}
hogares<- read_csv(
  "~/Desktop/UchicagoPolicyLab-Migration/Data/El Salvador- Censo 2024/Raw Data /Base de Datos de Hogares - CPV 2024 SV.csv",
  locale = locale(encoding = "UTF-8"),
) %>% clean_names()

hogares
```
```{r}
hogares_summary <- hogares %>%
  clean_names() %>%
  mutate(
    emigrant_household = ifelse(e01_emi_emigracion == 1, 1, 0),
    num_emigrants = ifelse(is.na(e01_1_emi_total), 0, e01_1_emi_total),

    # Classification
    one_emigrant = ifelse(num_emigrants == 1, 1, 0),
    multiple_emigrants = ifelse(num_emigrants >= 2, 1, 0),

    receives_remittances = ifelse(e02_emi_ayuda == 1, 1, 0),

    urban_rural = case_when(
      area == 1 ~ "urban",
      area == 2 ~ "rural",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(depto, deptodesc, munic, municdesc) %>%
  summarise(
    # -----------------------------
    # Basic household counts
    # -----------------------------
    total_households = n(),

    # -----------------------------
    # Emigrant household indicators
    # -----------------------------
    households_with_emigrants = sum(emigrant_household, na.rm = TRUE),
    households_with_1_emigrant = sum(one_emigrant, na.rm = TRUE),
    households_with_2plus_emigrants = sum(multiple_emigrants, na.rm = TRUE),

    # Total emigrants from households
    total_emigrants_household = sum(num_emigrants, na.rm = TRUE),

    # -----------------------------
    # Remittances
    # -----------------------------
    households_receiving_remittances = sum(receives_remittances, na.rm = TRUE),

    # Percentages
    pct_households_with_emigrants =
      100 * households_with_emigrants / total_households,

    pct_households_receiving_remittances =
      100 * households_receiving_remittances / total_households,

  ) %>%
  ungroup()

hogares_summary

```

# Lets join the households information into the summary of other variables

```{r}
base_muni <- base_muni %>%
  mutate(
    depto = sprintf("%02d", as.numeric(depto)),
    munic = sprintf("%02d", as.numeric(munic))
  ) %>%
  left_join(
    hogares_summary %>% 
      mutate(
        depto = sprintf("%02d", as.numeric(depto)),
        munic = sprintf("%02d", as.numeric(munic))
      ),
    by = c("depto", "munic")
  )

base_muni <- base_muni %>% 
  select(-ends_with(".y"))

base_muni
```
```{r}
base_muni <- base_muni %>%
  mutate(
    depto = sprintf("%02d", as.numeric(depto)),
    munic = sprintf("%02d", as.numeric(munic))
  ) %>%
  left_join(
    zonas_sv %>%
      mutate(
        depto = sprintf("%02d", as.numeric(depto)),
        munic = sprintf("%02d", as.numeric(munic))
      ),
    by = c("depto", "munic")
  )

base_muni <- base_muni %>% 
  select(-ends_with(".y"))

base_muni
```


```{r}
write_csv(base_muni,
          "../Data/El Salvador- Censo 2024/Processed/municipality_summary.csv")
```

## Now lets create the emigration data base

```{r}
emigration<- read_csv(
  "~/Desktop/UchicagoPolicyLab-Migration/Data/El Salvador- Censo 2024/Raw Data /Base de Datos de Emigración Internacional - CPV 2024 SV.csv",
  locale = locale(encoding = "UTF-8"),
) %>% clean_names()

emigration
```
```{r}

emigration_clean <- emigration %>% 
  select(
    depto, deptodesc, 
    munic, municdesc,
    cod_viv, cod_hog, cod_emig,
    e01_3_emi_sexo,     # sex
    e01_4_emi_edad,     # current age
    e01_5_emi_ano,      # year of departure
    e01_6_emi_pais,     # destination country
    e01_7_emi_causa,    # cause of emigration
    area                # 1 urban, 2 rural
  ) %>%
  # ------------------------
  # RENAME VARIABLES CLEANLY
  # ------------------------
  rename(
    sex                = e01_3_emi_sexo,
    age_current        = e01_4_emi_edad,
    year_departure     = e01_5_emi_ano,
    destination_country = e01_6_emi_pais,
    cause_emigration   = e01_7_emi_causa,
    urban_rural        = area
  ) %>%

  # ---------------------------------------
  # Calculate age at emigration
  # ---------------------------------------
  mutate(
    age_at_emigration = age_current - (2024 - year_departure),
    age_at_emigration = ifelse(age_at_emigration < 0, NA, age_at_emigration)
  ) %>%

  # ---------------------------------------
  # Create new age group (based on age at emigration)
  # ---------------------------------------
  mutate(
    age_group_emigration = case_when(
      age_at_emigration >= 0   & age_at_emigration <= 4   ~ "0-4",
      age_at_emigration >= 5   & age_at_emigration <= 9   ~ "5-9",
      age_at_emigration >= 10  & age_at_emigration <= 14  ~ "10-14",
      age_at_emigration >= 15  & age_at_emigration <= 19  ~ "15-19",
      age_at_emigration >= 20  & age_at_emigration <= 24  ~ "20-24",
      age_at_emigration >= 25  & age_at_emigration <= 29  ~ "25-29",
      age_at_emigration >= 30  & age_at_emigration <= 34  ~ "30-34",
      age_at_emigration >= 35  & age_at_emigration <= 39  ~ "35-39",
      age_at_emigration >= 40  & age_at_emigration <= 44  ~ "40-44",
      age_at_emigration >= 45  & age_at_emigration <= 49  ~ "45-49",
      age_at_emigration >= 50  & age_at_emigration <= 54  ~ "50-54",
      age_at_emigration >= 55  & age_at_emigration <= 59  ~ "55-59",
      age_at_emigration >= 60  & age_at_emigration <= 64  ~ "60-64",
      age_at_emigration >= 65  & age_at_emigration <= 69  ~ "65-69",
      age_at_emigration >= 70  & age_at_emigration <= 74  ~ "70-74",
      age_at_emigration >= 75  & age_at_emigration <= 79  ~ "75-79",
      age_at_emigration >= 80  & age_at_emigration <= 84  ~ "80-84",
      age_at_emigration >= 85  & age_at_emigration <= 89  ~ "85-89",
      age_at_emigration >= 90  & age_at_emigration <= 94  ~ "90-94",
      age_at_emigration >= 95                           ~ "95+",
      TRUE ~ NA_character_
    )
  ) %>%

  # ---------------------------------------
  # Binary variables
  # ---------------------------------------
  mutate(
    male      = ifelse(sex == 1, 1, 0),
    female    = ifelse(sex == 2, 1, 0),
    urban     = ifelse(urban_rural == 1, 1, 0),
    rural     = ifelse(urban_rural == 2, 1, 0)
  )

emigration_clean

```

```{r}
emigration_summary <- emigration_clean %>%
  mutate(
    sex = case_when(
      sex == 1 ~ "male",
      sex == 2 ~ "female",
      TRUE ~ NA_character_
    ),
    urban_rural = case_when(
      urban_rural == 1 ~ "urban",
      urban_rural == 2 ~ "rural",
      TRUE ~ NA_character_
    ),
    cause = case_when(
      cause_emigration == 1 ~ "work",
      cause_emigration == 2 ~ "marriage",
      cause_emigration == 3 ~ "family_reunification",
      cause_emigration == 4 ~ "job_offer",
      cause_emigration == 5 ~ "study",
      cause_emigration == 6 ~ "insecurity_violence",
      cause_emigration == 7 ~ "natural_disaster",
      cause_emigration == 8 ~ "deportation",
      cause_emigration == 9 ~ "other",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(
    depto, deptodesc,
    munic, municdesc,
    sex,
    urban_rural,
    cause,
    year_departure,
    age_group_emigration
  ) %>%
  summarise(
    emigrants = n(),
    .groups = "drop"
  )

emigration_summary

```
```{r}
emigration_summary <- emigration_summary %>%
  mutate(
    depto = sprintf("%02d", as.numeric(depto)),
    munic = sprintf("%02d", as.numeric(munic))
  ) %>%
  left_join(
    zonas_sv %>%
      mutate(
        depto = sprintf("%02d", as.numeric(depto)),
        munic = sprintf("%02d", as.numeric(munic))
      ),
    by = c("depto", "munic")
  )

emigration_summary  <- emigration_summary  %>% 
  select(-ends_with(".y"))

emigration_summary 
```

```{r}
write_csv(emigration_summary,
          "../Data/El Salvador- Censo 2024/Processed/emigration_summary.csv")
```
